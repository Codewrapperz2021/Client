{"ast":null,"code":"var _jsxFileName = \"C:\\\\xampp\\\\htdocs\\\\videovcr\\\\client\\\\src\\\\components\\\\Room\\\\Room.js\";\nimport React, { useState, useEffect, useRef } from 'react';\nimport Peer from 'simple-peer';\nimport styled from 'styled-components';\nimport socket from '../../socket';\nimport VideoCard from '../Video/VideoCard';\nimport Chat from '../Chat/Chat';\nimport Roomsidebar from '../Masterlayout/Roomsidebar';\nimport Navbar from '../Masterlayout/Navbar';\nimport Vnavbar from '../Masterlayout/Vnavbar';\nimport Vsidebar from '../Masterlayout/Vsidebar';\nimport Vfooter from '../Masterlayout/Vfooter';\n\nconst Room = props => {\n  const currentUser = sessionStorage.getItem('user');\n  const [peers, setPeers] = useState([]);\n  const [userVideoAudio, setUserVideoAudio] = useState({\n    localUser: {\n      video: true,\n      audio: true\n    }\n  });\n  const [videoDevices, setVideoDevices] = useState([]);\n  const [displayChat, setDisplayChat] = useState(false);\n  const [screenShare, setScreenShare] = useState(false);\n  const [showVideoDevices, setShowVideoDevices] = useState(false);\n  const peersRef = useRef([]);\n  const userVideoRef = useRef();\n  const screenTrackRef = useRef();\n  const userStream = useRef();\n  const roomId = props.match.params.roomId;\n\n  document.onkeydown = function (event) {\n    if (event.keyCode == 116 || event.keyCode == 82) {\n      event.preventDefault();\n    }\n  };\n\n  useEffect(() => {\n    // Get Video Devices\n    navigator.mediaDevices.enumerateDevices().then(devices => {\n      const filtered = devices.filter(device => device.kind === 'videoinput');\n      setVideoDevices(filtered);\n    }); // Set Back Button Event\n\n    window.addEventListener('popstate', goToBack); // Connect Camera & Mic\n\n    navigator.mediaDevices.getUserMedia({\n      video: true,\n      audio: true\n    }).then(stream => {\n      userVideoRef.current.srcObject = stream;\n      userStream.current = stream;\n      socket.emit('BE-join-room', {\n        roomId,\n        userName: currentUser\n      });\n      socket.on('FE-user-join', users => {\n        // all users\n        const peers = [];\n        users.forEach(_ref => {\n          let {\n            userId,\n            info\n          } = _ref;\n          let {\n            userName,\n            video,\n            audio\n          } = info;\n\n          if (userName !== currentUser) {\n            const peer = createPeer(userId, socket.id, stream);\n            peer.userName = userName;\n            peer.peerID = userId;\n            peersRef.current.push({\n              peerID: userId,\n              peer,\n              userName\n            });\n            peers.push(peer);\n            setUserVideoAudio(preList => {\n              return { ...preList,\n                [peer.userName]: {\n                  video,\n                  audio\n                }\n              };\n            });\n          }\n        });\n        setPeers(peers);\n      });\n      socket.on('FE-receive-call', _ref2 => {\n        let {\n          signal,\n          from,\n          info\n        } = _ref2;\n        let {\n          userName,\n          video,\n          audio\n        } = info;\n        const peerIdx = findPeer(from);\n\n        if (!peerIdx) {\n          const peer = addPeer(signal, from, stream);\n          peer.userName = userName;\n          peersRef.current.push({\n            peerID: from,\n            peer,\n            userName: userName\n          });\n          setPeers(users => {\n            return [...users, peer];\n          });\n          setUserVideoAudio(preList => {\n            return { ...preList,\n              [peer.userName]: {\n                video,\n                audio\n              }\n            };\n          });\n        }\n      });\n      socket.on('FE-call-accepted', _ref3 => {\n        let {\n          signal,\n          answerId\n        } = _ref3;\n        const peerIdx = findPeer(answerId);\n        peerIdx.peer.signal(signal);\n      });\n      socket.on('FE-user-leave', _ref4 => {\n        let {\n          userId,\n          userName\n        } = _ref4;\n        const peerIdx = findPeer(userId);\n        peerIdx.peer.destroy();\n        setPeers(users => {\n          users = users.filter(user => user.peerID !== peerIdx.peer.peerID);\n          return [...users];\n        });\n        peersRef.current = peersRef.current.filter(_ref5 => {\n          let {\n            peerID\n          } = _ref5;\n          return peerID !== userId;\n        });\n      });\n    });\n    socket.on('FE-toggle-camera', _ref6 => {\n      let {\n        userId,\n        switchTarget\n      } = _ref6;\n      const peerIdx = findPeer(userId);\n      setUserVideoAudio(preList => {\n        let video = preList[peerIdx.userName].video;\n        let audio = preList[peerIdx.userName].audio;\n        if (switchTarget === 'video') video = !video;else audio = !audio;\n        return { ...preList,\n          [peerIdx.userName]: {\n            video,\n            audio\n          }\n        };\n      });\n    });\n    return () => {\n      socket.disconnect();\n    }; // eslint-disable-next-line\n  }, []);\n\n  function createPeer(userId, caller, stream) {\n    const peer = new Peer({\n      initiator: true,\n      trickle: false,\n      stream\n    });\n    peer.on('signal', signal => {\n      socket.emit('BE-call-user', {\n        userToCall: userId,\n        from: caller,\n        signal\n      });\n    });\n    peer.on('disconnect', () => {\n      peer.destroy();\n    });\n    return peer;\n  }\n\n  function addPeer(incomingSignal, callerId, stream) {\n    const peer = new Peer({\n      initiator: false,\n      trickle: false,\n      stream\n    });\n    peer.on('signal', signal => {\n      socket.emit('BE-accept-call', {\n        signal,\n        to: callerId\n      });\n    });\n    peer.on('disconnect', () => {\n      peer.destroy();\n    });\n    peer.signal(incomingSignal);\n    return peer;\n  }\n\n  function findPeer(id) {\n    return peersRef.current.find(p => p.peerID === id);\n  }\n\n  function createUserVideo(peer, index, arr) {\n    return /*#__PURE__*/React.createElement(VideoBox, {\n      className: `width-peer${peers.length > 8 ? '' : peers.length}`,\n      onClick: expandScreen,\n      key: index,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 196,\n        columnNumber: 7\n      }\n    }, writeUserName(peer.userName), /*#__PURE__*/React.createElement(FaIcon, {\n      className: \"fas fa-expand\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 202,\n        columnNumber: 9\n      }\n    }), /*#__PURE__*/React.createElement(VideoCard, {\n      key: index,\n      peer: peer,\n      number: arr.length,\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 203,\n        columnNumber: 9\n      }\n    }));\n  }\n\n  function writeUserName(userName, index) {\n    if (userVideoAudio.hasOwnProperty(userName)) {\n      if (!userVideoAudio[userName].video) {\n        return /*#__PURE__*/React.createElement(UserName, {\n          key: userName,\n          __self: this,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 211,\n            columnNumber: 16\n          }\n        }, userName);\n      }\n    }\n  } // Open Chat\n\n\n  const clickChat = e => {\n    e.stopPropagation();\n    setDisplayChat(!displayChat);\n  }; // BackButton\n\n\n  const goToBack = e => {\n    e.preventDefault();\n    socket.emit('BE-leave-room', {\n      roomId,\n      leaver: currentUser\n    });\n    sessionStorage.removeItem('user');\n    window.location.href = '/';\n    console.log(\"success\");\n  };\n\n  const toggleCameraAudio = e => {\n    const target = e.target.getAttribute('data-switch');\n    setUserVideoAudio(preList => {\n      let videoSwitch = preList['localUser'].video;\n      let audioSwitch = preList['localUser'].audio;\n\n      if (target === 'video') {\n        const userVideoTrack = userVideoRef.current.srcObject.getVideoTracks()[0];\n        videoSwitch = !videoSwitch;\n        userVideoTrack.enabled = videoSwitch;\n      } else {\n        const userAudioTrack = userVideoRef.current.srcObject.getAudioTracks()[0];\n        audioSwitch = !audioSwitch;\n\n        if (userAudioTrack) {\n          userAudioTrack.enabled = audioSwitch;\n        } else {\n          userStream.current.getAudioTracks()[0].enabled = audioSwitch;\n        }\n      }\n\n      return { ...preList,\n        localUser: {\n          video: videoSwitch,\n          audio: audioSwitch\n        }\n      };\n    });\n    socket.emit('BE-toggle-camera-audio', {\n      roomId,\n      switchTarget: target\n    });\n  };\n\n  const clickScreenSharing = () => {\n    if (!screenShare) {\n      navigator.mediaDevices.getDisplayMedia({\n        cursor: true\n      }).then(stream => {\n        const screenTrack = stream.getTracks()[0];\n        peersRef.current.forEach(_ref7 => {\n          let {\n            peer\n          } = _ref7;\n          // replaceTrack (oldTrack, newTrack, oldStream);\n          peer.replaceTrack(peer.streams[0].getTracks().find(track => track.kind === 'video'), screenTrack, userStream.current);\n        }); // Listen click end\n\n        screenTrack.onended = () => {\n          peersRef.current.forEach(_ref8 => {\n            let {\n              peer\n            } = _ref8;\n            peer.replaceTrack(screenTrack, peer.streams[0].getTracks().find(track => track.kind === 'video'), userStream.current);\n          });\n          userVideoRef.current.srcObject = userStream.current;\n          setScreenShare(false);\n        };\n\n        userVideoRef.current.srcObject = stream;\n        screenTrackRef.current = screenTrack;\n        setScreenShare(true);\n      });\n    } else {\n      screenTrackRef.current.onended();\n    }\n  };\n\n  const expandScreen = e => {\n    const elem = e.target;\n\n    if (elem.requestFullscreen) {\n      elem.requestFullscreen();\n    } else if (elem.mozRequestFullScreen) {\n      /* Firefox */\n      elem.mozRequestFullScreen();\n    } else if (elem.webkitRequestFullscreen) {\n      /* Chrome, Safari & Opera */\n      elem.webkitRequestFullscreen();\n    } else if (elem.msRequestFullscreen) {\n      /* IE/Edge */\n      elem.msRequestFullscreen();\n    }\n  };\n\n  const clickBackground = () => {\n    if (!showVideoDevices) return;\n    setShowVideoDevices(false);\n  };\n\n  const clickCameraDevice = event => {\n    if (event && event.target && event.target.dataset && event.target.dataset.value) {\n      const deviceId = event.target.dataset.value;\n      const enabledAudio = userVideoRef.current.srcObject.getAudioTracks()[0].enabled;\n      navigator.mediaDevices.getUserMedia({\n        video: {\n          deviceId\n        },\n        audio: enabledAudio\n      }).then(stream => {\n        const newStreamTrack = stream.getTracks().find(track => track.kind === 'video');\n        const oldStreamTrack = userStream.current.getTracks().find(track => track.kind === 'video');\n        userStream.current.removeTrack(oldStreamTrack);\n        userStream.current.addTrack(newStreamTrack);\n        peersRef.current.forEach(_ref9 => {\n          let {\n            peer\n          } = _ref9;\n          // replaceTrack (oldTrack, newTrack, oldStream);\n          peer.replaceTrack(oldStreamTrack, newStreamTrack, userStream.current);\n        });\n      });\n    }\n  };\n\n  return (\n    /*#__PURE__*/\n    // <div>\n    //   <div className=\"sb-nav-fixed\">\n    //     <Vnavbar />\n    //     <div id=\"layoutSidenav\">\n    //       <Vsidebar />\n    //       <div id=\"layoutSidenav_nav\">\n    //       <Roomsidebar\n    //               clickScreenSharing={clickScreenSharing}\n    //               clickChat={clickChat}\n    //               clickCameraDevice={clickCameraDevice}\n    //               goToBack={goToBack}\n    //               toggleCameraAudio={toggleCameraAudio}\n    //               userVideoAudio={userVideoAudio['localUser']}\n    //               screenShare={screenShare}\n    //               videoDevices={videoDevices}\n    //               showVideoDevices={showVideoDevices}\n    //               setShowVideoDevices={setShowVideoDevices}\n    //             />\n    //       </div>\n    //       <div id=\"layoutSidenav_content\">\n    //         <RoomContainer onClick={clickBackground}>\n    //           <VideoAndBarContainer>\n    //             <VideoContainer>\n    //               {/* Current User Video */}\n    //               <VideoBox\n    //                 className={`width-peer${peers.length > 8 ? '' : peers.length}`}\n    //               >\n    //                 {userVideoAudio['localUser'].video ? null : (\n    //                   <UserName>{currentUser}</UserName>                     \n    //                 )}\n    //                 <FaIcon className='fas fa-expand' />\n    //                 <MyVideo\n    //                   onClick={expandScreen}\n    //                   ref={userVideoRef}\n    //                   muted\n    //                   autoPlay\n    //                   playInline                     \n    //                 ></MyVideo>    \n    //               </VideoBox>  \n    //               {/* <UsersName>{currentUser}</UsersName> */}\n    //               {/* Joined User Vidoe */}\n    //               {peers &&\n    //                 peers.map((peer, index, arr) => createUserVideo(peer, index, arr))}\n    //             </VideoContainer>\n    //           </VideoAndBarContainer>            \n    //           <Chat display={displayChat} roomId={roomId} />\n    //         </RoomContainer>\n    //         <Vfooter />\n    //       </div>\n    //     </div>\n    //   </div>\n    // </div>\n    React.createElement(\"div\", {\n      id: \"root\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 410,\n        columnNumber: 5\n      }\n    }, /*#__PURE__*/React.createElement(\"div\", {\n      id: \"main-wrapper\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 411,\n        columnNumber: 5\n      }\n    }, /*#__PURE__*/React.createElement(Vnavbar, {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 412,\n        columnNumber: 7\n      }\n    }), /*#__PURE__*/React.createElement(Vsidebar, {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 413,\n        columnNumber: 7\n      }\n    }), /*#__PURE__*/React.createElement(\"div\", {\n      class: \"content-body\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 414,\n        columnNumber: 7\n      }\n    }, /*#__PURE__*/React.createElement(\"div\", {\n      class: \"container-fluid\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 416,\n        columnNumber: 9\n      }\n    }, /*#__PURE__*/React.createElement(\"div\", {\n      class: \"row\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 417,\n        columnNumber: 11\n      }\n    }, /*#__PURE__*/React.createElement(\"div\", {\n      id: \"left-slide\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 418,\n        columnNumber: 13\n      }\n    }, /*#__PURE__*/React.createElement(\"div\", {\n      class: \"row mb-3\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 419,\n        columnNumber: 15\n      }\n    }, /*#__PURE__*/React.createElement(\"div\", {\n      className: \" container text-center col-md-6 shadow p-4 \",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 433,\n        columnNumber: 17\n      }\n    }, /*#__PURE__*/React.createElement(\"div\", {\n      className: \"d-flex justify-content-center p-4 mt-6\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 434,\n        columnNumber: 19\n      }\n    }, /*#__PURE__*/React.createElement(\"div\", {\n      className: \"d-flex flex-column\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 435,\n        columnNumber: 21\n      }\n    }, /*#__PURE__*/React.createElement(\"label\", {\n      style: {\n        fontSize: \"20px\",\n        marginTop: '5px'\n      },\n      className: \"mb-4\",\n      for: \"formGroupExampleInput\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 436,\n        columnNumber: 23\n      }\n    }, /*#__PURE__*/React.createElement(\"b\", {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 436,\n        columnNumber: 122\n      }\n    }, \"User Name\")), /*#__PURE__*/React.createElement(\"label\", {\n      style: {\n        fontSize: \"20px\"\n      },\n      className: \"mb-4\",\n      for: \"formGroupExampleInput\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 437,\n        columnNumber: 23\n      }\n    }, /*#__PURE__*/React.createElement(\"b\", {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 437,\n        columnNumber: 104\n      }\n    }, \"Room id\"))), /*#__PURE__*/React.createElement(\"div\", {\n      className: \"d-flex flex-column ml-3\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 439,\n        columnNumber: 21\n      }\n    }, /*#__PURE__*/React.createElement(\"input\", {\n      className: \"form-control mb-3 \",\n      type: \"text\",\n      placeholder: \"Smith\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 440,\n        columnNumber: 23\n      }\n    }), /*#__PURE__*/React.createElement(\"input\", {\n      className: \"form-control mb-3\",\n      type: \"text\",\n      placeholder: \"874\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 441,\n        columnNumber: 23\n      }\n    }))), /*#__PURE__*/React.createElement(\"button\", {\n      type: \"submit\",\n      class: \"btn btn-primary\",\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 444,\n        columnNumber: 19\n      }\n    }, \"Join\"))))))), /*#__PURE__*/React.createElement(Vfooter, {\n      __self: this,\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 452,\n        columnNumber: 7\n      }\n    })))\n  );\n};\n\nconst RoomContainer = styled.div`\n  display: flex;\n  width: 100%;\n  height: 100%;\n  flex-direction: row;\n`;\nconst VideoContainer = styled.div`\n  max-width: 100%;\n  height: 100%;\n  display: flex;\n  flex-direction: row;\n  justify-content: space-around;\n  flex-wrap: wrap;\n  align-items: center;\n  padding: 15px;\n  box-sizing: border-box;\n  gap: 10px;\n`;\nconst VideoAndBarContainer = styled.div`\n  position: relative;\n  width: 100%;\n  height: 100vh;\n`;\nconst MyVideo = styled.video``;\nconst VideoBox = styled.div`\n  position: relative;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  > video {\n    top: 0;\n    left: 0;\n    width: 100%;\n    height: 100%;\n  }\n\n  :hover {\n    > i {\n      display: block;\n    }\n  }\n`;\nconst UserName = styled.div`\n  position: absolute;\n  font-size: calc(20px + 5vmin);\n  z-index: 1;\n  color: #FFFFFF;\n`;\nconst UsersName = styled.div`\n  position: absolute;\n  font-size: calc(15px + 5vmin);\n  z-index: 1;\n  color: #FFFFFF;\n  position: relative;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n`;\nconst FaIcon = styled.i`\n  display: none;\n  position: absolute;\n  right: 15px;\n  top: 15px;\n`;\nexport default Room;","map":{"version":3,"sources":["C:/xampp/htdocs/videovcr/client/src/components/Room/Room.js"],"names":["React","useState","useEffect","useRef","Peer","styled","socket","VideoCard","Chat","Roomsidebar","Navbar","Vnavbar","Vsidebar","Vfooter","Room","props","currentUser","sessionStorage","getItem","peers","setPeers","userVideoAudio","setUserVideoAudio","localUser","video","audio","videoDevices","setVideoDevices","displayChat","setDisplayChat","screenShare","setScreenShare","showVideoDevices","setShowVideoDevices","peersRef","userVideoRef","screenTrackRef","userStream","roomId","match","params","document","onkeydown","event","keyCode","preventDefault","navigator","mediaDevices","enumerateDevices","then","devices","filtered","filter","device","kind","window","addEventListener","goToBack","getUserMedia","stream","current","srcObject","emit","userName","on","users","forEach","userId","info","peer","createPeer","id","peerID","push","preList","signal","from","peerIdx","findPeer","addPeer","answerId","destroy","user","switchTarget","disconnect","caller","initiator","trickle","userToCall","incomingSignal","callerId","to","find","p","createUserVideo","index","arr","length","expandScreen","writeUserName","hasOwnProperty","clickChat","e","stopPropagation","leaver","removeItem","location","href","console","log","toggleCameraAudio","target","getAttribute","videoSwitch","audioSwitch","userVideoTrack","getVideoTracks","enabled","userAudioTrack","getAudioTracks","clickScreenSharing","getDisplayMedia","cursor","screenTrack","getTracks","replaceTrack","streams","track","onended","elem","requestFullscreen","mozRequestFullScreen","webkitRequestFullscreen","msRequestFullscreen","clickBackground","clickCameraDevice","dataset","value","deviceId","enabledAudio","newStreamTrack","oldStreamTrack","removeTrack","addTrack","fontSize","marginTop","RoomContainer","div","VideoContainer","VideoAndBarContainer","MyVideo","VideoBox","UserName","UsersName","FaIcon","i"],"mappings":"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","sourcesContent":["import React, { useState, useEffect, useRef } from 'react';\r\nimport Peer from 'simple-peer';\r\nimport styled from 'styled-components';\r\nimport socket from '../../socket';\r\nimport VideoCard from '../Video/VideoCard';\r\nimport Chat from '../Chat/Chat';\r\nimport Roomsidebar from '../Masterlayout/Roomsidebar';\r\nimport Navbar from '../Masterlayout/Navbar';\r\nimport Vnavbar from '../Masterlayout/Vnavbar';\r\nimport Vsidebar from '../Masterlayout/Vsidebar';\r\nimport Vfooter from '../Masterlayout/Vfooter';\r\nconst Room = (props) => {\r\n  const currentUser = sessionStorage.getItem('user');\r\n  const [peers, setPeers] = useState([]);\r\n  const [userVideoAudio, setUserVideoAudio] = useState({\r\n    localUser: { video: true, audio: true },\r\n  });\r\n  const [videoDevices, setVideoDevices] = useState([]);\r\n  const [displayChat, setDisplayChat] = useState(false);\r\n  const [screenShare, setScreenShare] = useState(false);\r\n  const [showVideoDevices, setShowVideoDevices] = useState(false);\r\n  const peersRef = useRef([]);\r\n  const userVideoRef = useRef();\r\n  const screenTrackRef = useRef();\r\n  const userStream = useRef();\r\n  const roomId = props.match.params.roomId;\r\n\r\n  document.onkeydown=function(event){\r\n    if(event.keyCode==116 || event.keyCode == 82){\r\n      event.preventDefault();\r\n    }\r\n  }\r\n\r\n  useEffect(() => {\r\n    // Get Video Devices\r\n    navigator.mediaDevices.enumerateDevices().then((devices) => {\r\n      const filtered = devices.filter((device) => device.kind === 'videoinput');\r\n      setVideoDevices(filtered);\r\n    });\r\n\r\n    // Set Back Button Event\r\n    window.addEventListener('popstate', goToBack);\r\n\r\n\r\n    // Connect Camera & Mic\r\n    navigator.mediaDevices\r\n      .getUserMedia({ video: true, audio: true })\r\n      .then((stream) => {\r\n        userVideoRef.current.srcObject = stream;\r\n        userStream.current = stream;\r\n\r\n        socket.emit('BE-join-room', { roomId, userName: currentUser });\r\n        socket.on('FE-user-join', (users) => {\r\n          // all users\r\n          const peers = [];\r\n          users.forEach(({ userId, info }) => {\r\n            let { userName, video, audio } = info;\r\n\r\n            if (userName !== currentUser) {\r\n              const peer = createPeer(userId, socket.id, stream);\r\n\r\n              peer.userName = userName;\r\n              peer.peerID = userId;\r\n\r\n              peersRef.current.push({\r\n                peerID: userId,\r\n                peer,\r\n                userName,\r\n              });\r\n              peers.push(peer);\r\n\r\n              setUserVideoAudio((preList) => {\r\n                return {\r\n                  ...preList,\r\n                  [peer.userName]: { video, audio },\r\n                };\r\n              });\r\n            }\r\n          });\r\n\r\n          setPeers(peers);\r\n        });\r\n\r\n        socket.on('FE-receive-call', ({ signal, from, info }) => {\r\n          let { userName, video, audio } = info;\r\n          const peerIdx = findPeer(from);\r\n\r\n          if (!peerIdx) {\r\n            const peer = addPeer(signal, from, stream);\r\n\r\n            peer.userName = userName;\r\n\r\n            peersRef.current.push({\r\n              peerID: from,\r\n              peer,\r\n              userName: userName,\r\n            });\r\n            setPeers((users) => {\r\n              return [...users, peer];\r\n            });\r\n            setUserVideoAudio((preList) => {\r\n              return {\r\n                ...preList,\r\n                [peer.userName]: { video, audio },\r\n              };\r\n            });\r\n          }\r\n        });\r\n\r\n        socket.on('FE-call-accepted', ({ signal, answerId }) => {\r\n          const peerIdx = findPeer(answerId);\r\n          peerIdx.peer.signal(signal);\r\n        });\r\n\r\n        socket.on('FE-user-leave', ({ userId, userName }) => {\r\n          const peerIdx = findPeer(userId);\r\n          peerIdx.peer.destroy();\r\n          setPeers((users) => {\r\n            users = users.filter((user) => user.peerID !== peerIdx.peer.peerID);\r\n            return [...users];\r\n          });\r\n          peersRef.current = peersRef.current.filter(({ peerID }) => peerID !== userId);\r\n        });\r\n      });\r\n\r\n    socket.on('FE-toggle-camera', ({ userId, switchTarget }) => {\r\n      const peerIdx = findPeer(userId);\r\n\r\n      setUserVideoAudio((preList) => {\r\n        let video = preList[peerIdx.userName].video;\r\n        let audio = preList[peerIdx.userName].audio;\r\n\r\n        if (switchTarget === 'video') video = !video;\r\n        else audio = !audio;\r\n\r\n        return {\r\n          ...preList,\r\n          [peerIdx.userName]: { video, audio },\r\n        };\r\n      });\r\n    });\r\n\r\n    return () => {\r\n      socket.disconnect();\r\n    };\r\n    // eslint-disable-next-line\r\n  }, []);\r\n\r\n  function createPeer(userId, caller, stream) {\r\n    const peer = new Peer({\r\n      initiator: true,\r\n      trickle: false,\r\n      stream,\r\n    });\r\n\r\n    peer.on('signal', (signal) => {\r\n      socket.emit('BE-call-user', {\r\n        userToCall: userId,\r\n        from: caller,\r\n        signal,\r\n      });\r\n    });\r\n    peer.on('disconnect', () => {\r\n      peer.destroy();\r\n    });\r\n\r\n    return peer;\r\n  }\r\n\r\n  function addPeer(incomingSignal, callerId, stream) {\r\n    const peer = new Peer({\r\n      initiator: false,\r\n      trickle: false,\r\n      stream,\r\n    });\r\n\r\n    peer.on('signal', (signal) => {\r\n      socket.emit('BE-accept-call', { signal, to: callerId });\r\n    });\r\n\r\n    peer.on('disconnect', () => {\r\n      peer.destroy();\r\n    });\r\n\r\n    peer.signal(incomingSignal);\r\n\r\n    return peer;\r\n  }\r\n\r\n  function findPeer(id) {\r\n    return peersRef.current.find((p) => p.peerID === id);\r\n  }\r\n\r\n  function createUserVideo(peer, index, arr) {\r\n    return (\r\n      <VideoBox\r\n        className={`width-peer${peers.length > 8 ? '' : peers.length}`}\r\n        onClick={expandScreen}\r\n        key={index}\r\n      >\r\n        {writeUserName(peer.userName)}\r\n        <FaIcon className='fas fa-expand' />\r\n        <VideoCard key={index} peer={peer} number={arr.length} />\r\n      </VideoBox>\r\n    );\r\n  }\r\n\r\n  function writeUserName(userName, index) {\r\n    if (userVideoAudio.hasOwnProperty(userName)) {\r\n      if (!userVideoAudio[userName].video) {\r\n        return <UserName key={userName}>{userName}</UserName>;\r\n      }\r\n    }\r\n  }\r\n\r\n  // Open Chat\r\n  const clickChat = (e) => {\r\n    e.stopPropagation();\r\n    setDisplayChat(!displayChat);\r\n  };\r\n\r\n  // BackButton\r\n  const goToBack = (e) => {\r\n    e.preventDefault();\r\n    socket.emit('BE-leave-room', { roomId, leaver: currentUser });\r\n    sessionStorage.removeItem('user');\r\n    window.location.href = '/';\r\n    console.log(\"success\")\r\n  };\r\n\r\n  const toggleCameraAudio = (e) => {\r\n    const target = e.target.getAttribute('data-switch');\r\n\r\n    setUserVideoAudio((preList) => {\r\n      let videoSwitch = preList['localUser'].video;\r\n      let audioSwitch = preList['localUser'].audio;\r\n\r\n      if (target === 'video') {\r\n        const userVideoTrack = userVideoRef.current.srcObject.getVideoTracks()[0];\r\n        videoSwitch = !videoSwitch;\r\n        userVideoTrack.enabled = videoSwitch;\r\n      } else {\r\n        const userAudioTrack = userVideoRef.current.srcObject.getAudioTracks()[0];\r\n        audioSwitch = !audioSwitch;\r\n\r\n        if (userAudioTrack) {\r\n          userAudioTrack.enabled = audioSwitch;\r\n        } else {\r\n          userStream.current.getAudioTracks()[0].enabled = audioSwitch;\r\n        }\r\n      }\r\n\r\n      return {\r\n        ...preList,\r\n        localUser: { video: videoSwitch, audio: audioSwitch },\r\n      };\r\n    });\r\n\r\n    socket.emit('BE-toggle-camera-audio', { roomId, switchTarget: target });\r\n  };\r\n\r\n  const clickScreenSharing = () => {\r\n    if (!screenShare) {\r\n      navigator.mediaDevices\r\n        .getDisplayMedia({ cursor: true })\r\n        .then((stream) => {\r\n          const screenTrack = stream.getTracks()[0];\r\n\r\n          peersRef.current.forEach(({ peer }) => {\r\n            // replaceTrack (oldTrack, newTrack, oldStream);\r\n            peer.replaceTrack(\r\n              peer.streams[0]\r\n                .getTracks()\r\n                .find((track) => track.kind === 'video'),\r\n              screenTrack,\r\n              userStream.current\r\n            );\r\n          });\r\n\r\n          // Listen click end\r\n          screenTrack.onended = () => {\r\n            peersRef.current.forEach(({ peer }) => {\r\n              peer.replaceTrack(\r\n                screenTrack,\r\n                peer.streams[0]\r\n                  .getTracks()\r\n                  .find((track) => track.kind === 'video'),\r\n                userStream.current\r\n              );\r\n            });\r\n            userVideoRef.current.srcObject = userStream.current;\r\n            setScreenShare(false);\r\n          };\r\n\r\n          userVideoRef.current.srcObject = stream;\r\n          screenTrackRef.current = screenTrack;\r\n          setScreenShare(true);\r\n        });\r\n    } else {\r\n      screenTrackRef.current.onended();\r\n    }\r\n  };\r\n\r\n  const expandScreen = (e) => {\r\n    const elem = e.target;\r\n\r\n    if (elem.requestFullscreen) {\r\n      elem.requestFullscreen();\r\n    } else if (elem.mozRequestFullScreen) {\r\n      /* Firefox */\r\n      elem.mozRequestFullScreen();\r\n    } else if (elem.webkitRequestFullscreen) {\r\n      /* Chrome, Safari & Opera */\r\n      elem.webkitRequestFullscreen();\r\n    } else if (elem.msRequestFullscreen) {\r\n      /* IE/Edge */\r\n      elem.msRequestFullscreen();\r\n    }\r\n  };\r\n\r\n  const clickBackground = () => {\r\n    if (!showVideoDevices) return;\r\n\r\n    setShowVideoDevices(false);\r\n  };\r\n\r\n  const clickCameraDevice = (event) => {\r\n    if (event && event.target && event.target.dataset && event.target.dataset.value) {\r\n      const deviceId = event.target.dataset.value;\r\n      const enabledAudio = userVideoRef.current.srcObject.getAudioTracks()[0].enabled;\r\n\r\n      navigator.mediaDevices\r\n        .getUserMedia({ video: { deviceId }, audio: enabledAudio })\r\n        .then((stream) => {\r\n          const newStreamTrack = stream.getTracks().find((track) => track.kind === 'video');\r\n          const oldStreamTrack = userStream.current\r\n            .getTracks()\r\n            .find((track) => track.kind === 'video');\r\n\r\n          userStream.current.removeTrack(oldStreamTrack);\r\n          userStream.current.addTrack(newStreamTrack);\r\n\r\n          peersRef.current.forEach(({ peer }) => {\r\n            // replaceTrack (oldTrack, newTrack, oldStream);\r\n            peer.replaceTrack(\r\n              oldStreamTrack,\r\n              newStreamTrack,\r\n              userStream.current\r\n            );\r\n          });\r\n        });\r\n    }\r\n  };\r\n\r\n  return (\r\n    // <div>\r\n    //   <div className=\"sb-nav-fixed\">\r\n    //     <Vnavbar />\r\n    //     <div id=\"layoutSidenav\">\r\n    //       <Vsidebar />\r\n    //       <div id=\"layoutSidenav_nav\">\r\n    //       <Roomsidebar\r\n    //               clickScreenSharing={clickScreenSharing}\r\n    //               clickChat={clickChat}\r\n    //               clickCameraDevice={clickCameraDevice}\r\n    //               goToBack={goToBack}\r\n    //               toggleCameraAudio={toggleCameraAudio}\r\n    //               userVideoAudio={userVideoAudio['localUser']}\r\n    //               screenShare={screenShare}\r\n    //               videoDevices={videoDevices}\r\n    //               showVideoDevices={showVideoDevices}\r\n    //               setShowVideoDevices={setShowVideoDevices}\r\n    //             />\r\n    //       </div>\r\n    //       <div id=\"layoutSidenav_content\">\r\n           \r\n    //         <RoomContainer onClick={clickBackground}>\r\n    //           <VideoAndBarContainer>\r\n    //             <VideoContainer>\r\n    //               {/* Current User Video */}\r\n    //               <VideoBox\r\n    //                 className={`width-peer${peers.length > 8 ? '' : peers.length}`}\r\n    //               >\r\n    //                 {userVideoAudio['localUser'].video ? null : (\r\n    //                   <UserName>{currentUser}</UserName>                     \r\n    //                 )}\r\n    //                 <FaIcon className='fas fa-expand' />\r\n    //                 <MyVideo\r\n    //                   onClick={expandScreen}\r\n    //                   ref={userVideoRef}\r\n    //                   muted\r\n    //                   autoPlay\r\n    //                   playInline                     \r\n    //                 ></MyVideo>    \r\n    //               </VideoBox>  \r\n    //               {/* <UsersName>{currentUser}</UsersName> */}\r\n    //               {/* Joined User Vidoe */}\r\n    //               {peers &&\r\n    //                 peers.map((peer, index, arr) => createUserVideo(peer, index, arr))}\r\n    //             </VideoContainer>\r\n    //           </VideoAndBarContainer>            \r\n    //           <Chat display={displayChat} roomId={roomId} />\r\n    //         </RoomContainer>\r\n    //         <Vfooter />\r\n    //       </div>\r\n    //     </div>\r\n    //   </div>\r\n    // </div>\r\n\r\n    <div id=\"root\">\r\n    <div id=\"main-wrapper\">\r\n      <Vnavbar />\r\n      <Vsidebar />\r\n      <div class=\"content-body\">\r\n        {/* <!-- row --> */}\r\n        <div class=\"container-fluid\">\r\n          <div class=\"row\">\r\n            <div id=\"left-slide\">\r\n              <div class=\"row mb-3\">\r\n\r\n                {/* <div class=\"col-xl-4 col-md-6 mb-4\">\r\n                  <img src={} alt=\"vc1\" width=\"450\" height=\"250\" />\r\n                </div>\r\n\r\n                <div class=\"col-xl-4 col-md-6 mb-4\">\r\n                  <img src={} alt=\"vc1\" width=\"450\" height=\"250\" />\r\n                </div>\r\n\r\n                <div class=\"col-xl-4 col-md-6 mb-4\">\r\n                  <img src={vc3} alt=\"vc1\" width=\"450\" height=\"250\" />\r\n                </div> */}\r\n\r\n                <div className=' container text-center col-md-6 shadow p-4 '>\r\n                  <div className='d-flex justify-content-center p-4 mt-6'>\r\n                    <div className='d-flex flex-column'>\r\n                      <label style={{ fontSize: \"20px\", marginTop: '5px' }} className=\"mb-4\" for=\"formGroupExampleInput\"><b>User Name</b></label>\r\n                      <label style={{ fontSize: \"20px\" }} className=\"mb-4\" for=\"formGroupExampleInput\"><b>Room id</b></label>\r\n                    </div>\r\n                    <div className='d-flex flex-column ml-3'>\r\n                      <input className=\"form-control mb-3 \" type=\"text\" placeholder=\"Smith\"  />\r\n                      <input className=\"form-control mb-3\" type=\"text\" placeholder=\"874\"  />\r\n                    </div>\r\n                  </div>\r\n                  <button type=\"submit\" class=\"btn btn-primary\">Join</button>\r\n                  {/* {err ? <div style={{ marginTop: '10px', fontSize: '20px', color: '#e85a71' }}></div> : null} */}\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n      <Vfooter />\r\n    </div>\r\n  </div>\r\n  );\r\n};\r\n\r\nconst RoomContainer = styled.div`\r\n  display: flex;\r\n  width: 100%;\r\n  height: 100%;\r\n  flex-direction: row;\r\n`;\r\n\r\nconst VideoContainer = styled.div`\r\n  max-width: 100%;\r\n  height: 100%;\r\n  display: flex;\r\n  flex-direction: row;\r\n  justify-content: space-around;\r\n  flex-wrap: wrap;\r\n  align-items: center;\r\n  padding: 15px;\r\n  box-sizing: border-box;\r\n  gap: 10px;\r\n`;\r\n\r\nconst VideoAndBarContainer = styled.div`\r\n  position: relative;\r\n  width: 100%;\r\n  height: 100vh;\r\n`;\r\nconst MyVideo = styled.video``;\r\nconst VideoBox = styled.div`\r\n  position: relative;\r\n  display: flex;\r\n  justify-content: center;\r\n  align-items: center;\r\n  > video {\r\n    top: 0;\r\n    left: 0;\r\n    width: 100%;\r\n    height: 100%;\r\n  }\r\n\r\n  :hover {\r\n    > i {\r\n      display: block;\r\n    }\r\n  }\r\n`;\r\n\r\nconst UserName = styled.div`\r\n  position: absolute;\r\n  font-size: calc(20px + 5vmin);\r\n  z-index: 1;\r\n  color: #FFFFFF;\r\n`;\r\nconst UsersName = styled.div`\r\n  position: absolute;\r\n  font-size: calc(15px + 5vmin);\r\n  z-index: 1;\r\n  color: #FFFFFF;\r\n  position: relative;\r\n  display: flex;\r\n  justify-content: center;\r\n  align-items: center;\r\n`;\r\n\r\n\r\nconst FaIcon = styled.i`\r\n  display: none;\r\n  position: absolute;\r\n  right: 15px;\r\n  top: 15px;\r\n`;\r\n\r\nexport default Room;"]},"metadata":{},"sourceType":"module"}